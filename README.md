# byoa (Bring your Own AKO Demo)

## Goal of this repo
This repo spin up a full Avi environment in vCenter in conjunction with 2 * k8s clusters (cluster#1 uses Calico with ClusterIP while cluster#2 uses Antrea with LocalNodePort) including AKO in order to demonstrate:
- AKO installation inside K8s: command generated by the output of the Terraform plan
- K8s deployment:  ```k apply -f deployment.yml```
- K8s service type ClusterIP: ```k apply -f service_clusterIP.yml```
- Scale your deployment: ```k scale deployment web-front1 --replicas=6)```
- Create an ingress (unsecured): ```k apply -f ingress.yml```
- Create a secured ingress (based on a TLS cert already configured in a K8s secret): ```k apply -f secure_ingress.yml```
- Apply a WAF policy to your secured ingress: ```k apply -f avi_crd_hostrule_waf.yml```
- Upgrade your unsecured ingress to a secure ingress (based on a TLS cert already configured in the Avi Controller): ```k apply -f avi_crd_hostrule_tls_cert.yml```


## Prerequisites:
- Terraform:
```shell
Terraform v1.0.6
on linux_amd64
+ provider registry.terraform.io/hashicorp/local v2.1.0
+ provider registry.terraform.io/hashicorp/null v3.1.0
+ provider registry.terraform.io/hashicorp/template v2.2.0
+ provider registry.terraform.io/hashicorp/tls v3.1.0
+ provider registry.terraform.io/hashicorp/vsphere v2.0.2
```
https://learn.hashicorp.com/tutorials/terraform/install-cli

- GOVC:
```shell
govc v0.24.0
```
https://github.com/vmware/govmomi/tree/master/govc

- Inside the target vCenter:
  - Have a VM template ready for Avi Controller called ```controller-21.1.1-template```
  - Have a VM template ready for Ubuntu focal called ```ubuntu-focal-20.04-cloudimg-template```
  - Have a VM template ready for Ubuntu bionic called ```ubuntu-bionic-18.04-cloudimg-template```
  - DHCP available for all the networks


## clone this repo:

git clone https://github.com/tacobayle/byoa

## Variables:
- define the following environment variables:
  - ```vsphere_user```
  - ```vsphere_password```
  - ```vsphere_server```
  - ```avi_password```
  - ```avi_username```
  - ```avi_vsphere_user```
  - ```avi_vsphere_password```
  - ```avi_vsphere_server # use IP and not FQDN```
  - ```docker_registry_username # this will avoid download issue when downloading docker images```
  - ```docker_registry_password # this will avoid download issue when downloading docker images```
  - ```docker_registry_email # this will avoid download issue when downloading docker images```

- define the following vCenter variables inside variables.tf
```
variable "vcenter" {
  type = map
  default = {
    dc = "wdc-06-vc12"
    cluster = "wdc-06-vc12c01"
    datastore = "wdc-06-vc12c01-vsan"
    resource_pool = "wdc-06-vc12c01/Resources"
    folder = "Nic_K8S" # needs to be changed if duplicate this repo
    management_network = {
      name = "vxw-dvs-34-virtualwire-3-sid-6120002-wdc-06-vc12-avi-mgmt"
    }
    vip_network = {
      name = "vxw-dvs-34-virtualwire-120-sid-6120119-wdc-06-vc12-avi-dev116"
    }
  }
}
```

- update the following variables according to the resources that you plan to use (in variables.tf):
```shell
    network_vip = {
      ipStartPool = "200" # needs to be changed if duplicate this repo
      ipEndPool = "209" # needs to be changed if duplicate this repo
      cidr = "100.64.133.0/24" # needs to be changed if duplicate this repo
    }  
```

1. All the parameters/variables defined in variables.tf

## Use terraform plan to:
- Create a new folder within vCenter
- Create a jump host within the vCenter folder
- Create a client VM within the vCenter folder 
- Create 2 * k8s clusters:
  - 1 master node per cluster
  - 2 workers nodes per cluster
  - k8S version is defined per cluster in variables.tf (vmw.kubernetes.[].version)
  - Docker version is defined per cluster in variables.tf (vmw.kubernetes.[].docker.version)
  - AKO version is defined per cluster in variables.tf (vmw.kubernetes.[].ako.version)
  - CNI name is defined (vmw.kubernetes.[].cni.name)
  - CNI yaml manifest url is defined (vmw.kubernetes.[].cni.url)
- Spin up 1 Avi Controller VM
- Configure Avi Controller:
  - Bootstrap Avi Controller (Password, NTP, DNS)
  - VMW cloud
  - Service Engine Groups (Default SEG is used for VMware Cloud and by cluster#2), a dedicated SEG is configured for cluster#1
  - DNS VS is used in order to demonstrate FQDN registration reachable outside k8s cluster
  

## Run the terraform plan:
- create:
```
terraform apply -auto-approve
```
- destroy:
```
use the command provided by terraform output
```