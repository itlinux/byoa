# byoa (Bring your Own AKO Demo)

## Goal of this repo
This repo spin up a full Avi environment in vCenter in conjunction with 2 * k8s clusters (cluster#1 uses Calico with ClusterIP while cluster#2 uses Antrea with LocalNodePort) including AKO in order to demonstrate:


## Prerequisites:
- Terraform:
```shell
Terraform v1.0.6
on linux_amd64
+ provider registry.terraform.io/hashicorp/local v2.1.0
+ provider registry.terraform.io/hashicorp/null v3.1.0
+ provider registry.terraform.io/hashicorp/template v2.2.0
+ provider registry.terraform.io/hashicorp/tls v3.1.0
+ provider registry.terraform.io/hashicorp/vsphere v2.0.2
```
https://learn.hashicorp.com/tutorials/terraform/install-cli

- Inside the target vCenter:
  - Have a VM template ready for Avi Controller called ```controller-21.1.1-template```
  - Have a VM template ready for Ubuntu focal called ```ubuntu-focal-20.04-cloudimg-template```
  - Have a VM template ready for Ubuntu bionic called ```ubuntu-bionic-18.04-cloudimg-template```
  - DHCP available for the following networks:
    - management network defined in vcenter.management_network.name
    - k8s network defined in vcenter.k8s_network.name


## clone this repo:

git clone https://github.com/tacobayle/byoa

## Variables:
- define the following environment variables:
  - ```vsphere_user```
  - ```vsphere_password```
  - ```vsphere_server```
  - ```avi_password```
  - ```avi_username```
  - ```avi_vsphere_user```
  - ```avi_vsphere_password```
  - ```avi_vsphere_server # use IP and not FQDN```
  - ```docker_registry_username # this will avoid download issue when downloading docker images```
  - ```docker_registry_password # this will avoid download issue when downloading docker images```
  - ```docker_registry_email # this will avoid download issue when downloading docker images```

- define the following vCenter variables inside vcenter.json
```
{
  "vcenter": {
    "dc": "wdc-06-vc12",
    "cluster": "wdc-06-vc12c01",
    "datastore": "wdc-06-vc12c01-vsan",
    "resource_pool": "wdc-06-vc12c01/Resources",
    "folder": "Nic_K8S",
    "management_network": {
      "name": "vxw-dvs-34-virtualwire-3-sid-6120002-wdc-06-vc12-avi-mgmt"
    },
    "vip_network": {
      "name": "vxw-dvs-34-virtualwire-120-sid-6120119-wdc-06-vc12-avi-dev116",
      "cidr": "10.1.1.0/24"
    },
    "k8s_network": {
      "name": "vxw-dvs-34-virtualwire-116-sid-6120115-wdc-06-vc12-avi-dev112"
    }
  }
}
```

- All the other variables can be kept as they are


## Use terraform apply to:
- Create a new folder within vCenter
- Create a jump host within the vCenter folder attached to management network leveraging DHCP
- Create a client VM within the vCenter folder attached to management network leveraging DHCP and to the vip network using a static IP (defined in client.vip_IP) with Avi DNS configured as DNS server
- Create/Configure 2 * k8s clusters:
  - master and worker nodes are attached to management network and k8s network leveraging DHCP
  - 1 master node per cluster
  - 2 workers nodes per cluster
  - k8S version is defined per cluster in variables.tf (vmw.kubernetes.[].version)
  - Docker version is defined per cluster in variables.tf (vmw.kubernetes.[].docker.version)
  - AKO version is defined per cluster in variables.tf (vmw.kubernetes.[].ako.version)
  - CNI name is defined (vmw.kubernetes.[].cni.name)
  - CNI yaml manifest url is defined (vmw.kubernetes.[].cni.url)
- Spin up 1 Avi Controller VM within the vCenter folder attached to management network leveraging DHCP
- Configure Avi Controller:
  - Bootstrap Avi Controller (Password, NTP, DNS)
  - VMW cloud
  - Service Engine Groups (Default SEG is used for VMware Cloud and by cluster#2), a dedicated SEG is configured for cluster#1
  - DNS VS is used in order to demonstrate FQDN registration reachable outside k8s cluster
  

## Run the terraform plan:
- create:
```
terraform apply -auto-approve -var-file=vcenter.json
```
- destroy:
```
use the command provided by terraform output
```

## Demonstrate Ako

- AKO installation inside K8s: command generated by the output of the Terraform plan
- K8s deployment:  ```k apply -f deployment.yml```
- K8s service type ClusterIP: ```k apply -f service_clusterIP.yml```
- Scale your deployment: ```k scale deployment web-front1 --replicas=6```
- Create an ingress (unsecured): ```k apply -f ingress.yml```
- Create a secured ingress (based on a TLS cert already configured in a K8s secret): ```k apply -f secure_ingress.yml```
- Apply a WAF policy to your secured ingress: ```k apply -f avi_crd_hostrule_waf.yml```
- Upgrade your unsecured ingress to a secure ingress (based on a TLS cert already configured in the Avi Controller): ```k apply -f avi_crd_hostrule_tls_cert.yml```